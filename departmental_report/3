var render = require("../util/render")
var fs = require("fs");
var slick = require("slick");
var _ = require("underscore");
var bindListener = require("../util/bind_listener");
var d3 = require("d3-browserify");

var BudgetPie = module.exports = function(report, parentDept) {
  this._report = report;
  this._parentDept = parentDept._root; //FIXME
  this._report.registerSelectionChangeCallback(bindListener(this, this._onSelectionChange));
  this._layout = d3.layout.pie().sort(null).value(function(d) { return d.value; });
}

BudgetPie.prototype._template = fs.readFileSync(__dirname + "/../../../templates/budget_pie.mustache", 'utf8');

BudgetPie.prototype.render = function(selector) {
  this._element = render(this._template, selector);
  this._initD3();
}

BudgetPie.prototype._initD3 = function() {
  var width = this._element.offsetWidth;
  var height = this._element.offsetWidth;
  var radius = width /2;
  var svg = d3.select(slick.find(".chart", this._element))
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");


  this._arc = d3.svg.arc()
      .outerRadius(radius - 10)
      .innerRadius(radius - 70);

  var data = this._chartData(this._parentDept);

  this._slice = svg.selectAll(".arc").data(this._layout(data))
    .enter().append("g").attr("class", "arc")

  this._slice.append("path")
    .attr("d", this._arc)
    .style("fill", function(d) { return d.data.color; });
}

BudgetPie.prototype._onSelectionChange = function(selection) {
  var dept = selection._root; //FIXME
  var data = this._chartData(dept);
  this._slice.data(this._layout(data));
  this._slice.attr("d", this._arc);
}

BudgetPie.prototype._chartData = function(dept) {
  return [
    { color: "#009ade", value: dept.cash_budget() },
    { color: "#ffffff", value: this._parentDept.cash_budget() - dept.cash_budget()}
  ]

}
